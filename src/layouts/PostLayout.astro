---
import BaseLayout from './BaseLayout.astro';
import type { MarkdownHeading } from 'astro';

interface Props {
  title: string;
  description: string;
  date: Date;
  category: string;
  tags: string[];
  heroSrc?: string;
  headings: MarkdownHeading[];
  readingTime: number;
}

const { title, description, date, category, tags, heroSrc, headings, readingTime } = Astro.props;

const categoryColors: Record<string, string> = {
  cloud: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
  development: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
  kubernetes: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
};

const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const tocHeadings = headings.filter((h) => h.depth <= 3);
---

<BaseLayout title={title} description={description} image={heroSrc}>
  <article class="mx-auto max-w-7xl px-4 py-8">
    <!-- Header -->
    <header class="mx-auto max-w-3xl animate-bento-in">
      <a href="/" class="inline-flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors mb-6">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to blog
      </a>

      <span class={`inline-block rounded-full px-3 py-1 text-xs font-medium ${categoryColors[category]}`}>
        {category}
      </span>

      <h1 class="mt-3 text-3xl font-bold tracking-tight sm:text-4xl">
        {title}
      </h1>

      <div class="mt-4 flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
        <time datetime={date.toISOString()}>{formattedDate}</time>
        <span>&middot;</span>
        <span>{readingTime} min read</span>
      </div>

      {tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2">
          {tags.map((tag) => (
            <span class="rounded-md bg-gray-100 dark:bg-gray-800 px-2.5 py-1 text-xs text-gray-600 dark:text-gray-400">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    {heroSrc && (
      <div class="mx-auto mt-8 max-w-4xl animate-bento-in" style="animation-delay: 100ms">
        <img
          src={heroSrc}
          alt={title}
          class="w-full rounded-2xl"
          loading="eager"
        />
      </div>
    )}

    <!-- Content with optional TOC -->
    <div class="mx-auto mt-10 max-w-7xl lg:grid lg:grid-cols-[1fr_220px] lg:gap-10">
      <div class="mx-auto max-w-3xl lg:mx-0 lg:max-w-none animate-bento-in" style="animation-delay: 150ms">
        <div class="prose prose-lg dark:prose-invert max-w-none prose-headings:scroll-mt-20 prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-img:rounded-xl">
          <slot />
        </div>
      </div>

      {tocHeadings.length > 2 && (
        <aside class="hidden lg:block">
          <nav class="sticky top-20 text-sm" id="toc-nav">
            <h2 class="mb-3 font-semibold text-gray-900 dark:text-gray-100">On this page</h2>
            <ul class="space-y-2 text-gray-500 dark:text-gray-400">
              {tocHeadings.map((heading) => (
                <li style={`padding-left: ${(heading.depth - 2) * 0.75}rem`}>
                  <a
                    href={`#${heading.slug}`}
                    data-toc={heading.slug}
                    class="toc-link block transition-colors duration-150 hover:text-gray-900 dark:hover:text-gray-100"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .toc-link.is-active {
    color: var(--color-blue-600, #2563eb);
  }
  :global(.dark) .toc-link.is-active {
    color: var(--color-blue-400, #60a5fa);
  }
</style>

<script>
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  if (tocLinks.length > 0) {
    const headingIds = Array.from(tocLinks).map((a) => a.dataset.toc!);
    const headingEls = headingIds
      .map((id) => document.getElementById(id))
      .filter(Boolean) as HTMLElement[];

    function updateActive() {
      let activeId = headingIds[0];
      for (const el of headingEls) {
        if (el.getBoundingClientRect().top <= 100) {
          activeId = el.id;
        } else {
          break;
        }
      }
      tocLinks.forEach((link) => {
        link.classList.toggle('is-active', link.dataset.toc === activeId);
      });
    }

    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActive();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });
    updateActive();
  }
</script>
