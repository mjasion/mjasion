---
import BaseLayout from './BaseLayout.astro';
import { ArrowLeft } from '@lucide/astro';
import type { MarkdownHeading } from 'astro';

interface Props {
  title: string;
  description: string;
  date: Date;
  category: string;
  tags: string[];
  heroSrc?: string;
  headings: MarkdownHeading[];
  readingTime: number;
}

const { title, description, date, category, tags, heroSrc, headings, readingTime } = Astro.props;

const categoryColors: Record<string, string> = {
  cloud: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
  development: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
  kubernetes: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
};

const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const tocHeadings = headings.filter((h) => h.depth <= 3);
---

<BaseLayout title={title} description={description} image={heroSrc}>
  <article class="mx-auto max-w-5xl px-4 py-8">
    <!-- Header -->
    <header class="animate-bento-in">
      <a href="/" class="inline-flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors mb-6">
        <ArrowLeft class="h-4 w-4" />
        Back to blog
      </a>

      <span class={`inline-block rounded-full px-3 py-1 text-xs font-medium ${categoryColors[category]}`}>
        {category}
      </span>

      <h1 class="mt-3 text-3xl font-bold tracking-tight sm:text-4xl">
        {title}
      </h1>

      <div class="mt-4 flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
        <time datetime={date.toISOString()}>{formattedDate}</time>
        <span>&middot;</span>
        <span>{readingTime} min read</span>
      </div>

      {tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2">
          {tags.map((tag) => (
            <span class="rounded-md bg-gray-100 dark:bg-gray-800 px-2.5 py-1 text-xs text-gray-600 dark:text-gray-400">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    {heroSrc && (
      <div class="mt-8 animate-bento-in" style="animation-delay: 100ms">
        <img
          src={heroSrc}
          alt={title}
          class="w-full rounded-2xl"
          loading="eager"
        />
      </div>
    )}

    <!-- Content with optional TOC -->
    <div class="mx-auto mt-10 max-w-5xl xl:grid xl:grid-cols-[1fr_200px] xl:gap-8">
      <div class="mx-auto max-w-3xl xl:mx-0 xl:max-w-none min-w-0 animate-bento-in" style="animation-delay: 150ms">
        <div class="prose prose-lg dark:prose-invert max-w-none prose-headings:scroll-mt-16 lg:prose-headings:scroll-mt-8 prose-a:text-accent-600 dark:prose-a:text-accent-400 prose-img:rounded-xl">
          <slot />
        </div>
      </div>

      {tocHeadings.length > 2 && (
        <aside class="hidden xl:block">
          <nav class="sticky top-8 text-sm" id="toc-nav">
            <h2 class="mb-3 font-semibold text-gray-900 dark:text-gray-100">On this page</h2>
            <ul class="space-y-2 text-gray-500 dark:text-gray-400">
              {tocHeadings.map((heading) => (
                <li style={`padding-left: ${(heading.depth - 2) * 0.75}rem`}>
                  <a
                    href={`#${heading.slug}`}
                    data-toc={heading.slug}
                    class="toc-link block transition-colors duration-150 hover:text-gray-900 dark:hover:text-gray-100"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}
    </div>
  </article>

  <!-- Lightbox overlay -->
  <div
    id="lightbox"
    class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/80 backdrop-blur-sm cursor-zoom-out print:hidden"
    role="dialog"
    aria-label="Image preview"
  >
    <img id="lightbox-img" class="max-h-[90vh] max-w-[90vw] rounded-xl object-contain" alt="" />
  </div>
</BaseLayout>

<style>
  .toc-link.is-active {
    color: var(--color-accent-600, #2563eb);
  }
  .prose :global(img) {
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .prose :global(img:hover) {
    transform: scale(1.03);
  }

  :global(.dark) .toc-link.is-active {
    color: var(--color-accent-400, #60a5fa);
  }
</style>

<script>
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  if (tocLinks.length > 0) {
    const headingIds = Array.from(tocLinks).map((a) => a.dataset.toc!);
    const headingEls = headingIds
      .map((id) => document.getElementById(id))
      .filter(Boolean) as HTMLElement[];

    function updateActive() {
      let activeId = headingIds[0];
      for (const el of headingEls) {
        if (el.getBoundingClientRect().top <= 100) {
          activeId = el.id;
        } else {
          break;
        }
      }
      tocLinks.forEach((link) => {
        link.classList.toggle('is-active', link.dataset.toc === activeId);
      });
    }

    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActive();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });
    updateActive();
  }

  // Lightbox for prose images
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;

  function openLightbox(src: string, alt: string) {
    lightboxImg.src = src;
    lightboxImg.alt = alt;
    lightbox!.classList.remove('hidden');
    lightbox!.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox!.classList.add('hidden');
    lightbox!.classList.remove('flex');
    document.body.style.overflow = '';
  }

  document.querySelectorAll('.prose img').forEach((img) => {
    const el = img as HTMLImageElement;
    el.style.cursor = 'zoom-in';
    el.addEventListener('click', () => openLightbox(el.src, el.alt));
  });

  lightbox?.addEventListener('click', closeLightbox);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !lightbox!.classList.contains('hidden')) {
      closeLightbox();
    }
  });
</script>
