---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogCard from '../../../components/BlogCard.astro';
import { ArrowLeft } from '@lucide/astro';

const categoryLabels: Record<string, string> = {
  cloud: 'Cloud',
  development: 'Development',
  kubernetes: 'Kubernetes',
};

const categoryDescriptions: Record<string, string> = {
  cloud: 'Articles about cloud infrastructure, AWS, Terraform, and cloud services',
  development: 'Articles about software development, tools, and best practices',
  kubernetes: 'Articles about Kubernetes, container orchestration, and service mesh',
};

export async function getStaticPaths() {
  const now = new Date();
  const posts = (await getCollection('posts', ({ data }) => !data.draft && (!import.meta.env.PROD || data.date <= now)))
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  const categories = new Map<string, typeof posts>();
  for (const post of posts) {
    const cat = post.data.category;
    const existing = categories.get(cat) ?? [];
    existing.push(post);
    categories.set(cat, existing);
  }

  return Array.from(categories.entries()).map(([category, categoryPosts]) => ({
    params: { category },
    props: { category, posts: categoryPosts },
  }));
}

const { category, posts } = Astro.props;
const label = categoryLabels[category] ?? category;
const description = categoryDescriptions[category] ?? `Articles about ${category}`;

const siteUrl = Astro.site?.toString().replace(/\/$/, '') ?? 'https://mjasion.pl';

const collectionPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: `${label} Articles`,
  description,
  url: `${siteUrl}/posts/${category}/`,
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: posts.length,
    itemListElement: posts.map((post: any, i: number) => ({
      '@type': 'ListItem',
      position: i + 1,
      url: `${siteUrl}/posts/${post.id}/`,
    })),
  },
};
---

<BaseLayout
  title={`${label} Articles`}
  description={description}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  </Fragment>
  <div class="mx-auto max-w-6xl px-4 py-8">
    <a href="/" class="inline-flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors mb-6">
      <ArrowLeft class="h-4 w-4" />
      Back to blog
    </a>

    <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">
      {label}
    </h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">{posts.length} {posts.length === 1 ? 'post' : 'posts'}</p>

    <div class="mt-8 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
      {posts.map((post: any) => (
        <BlogCard post={post} />
      ))}
    </div>
  </div>
</BaseLayout>
