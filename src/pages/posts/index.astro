---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';

const categoryLabels: Record<string, string> = {
  cloud: 'Cloud',
  development: 'Development',
  kubernetes: 'Kubernetes',
};

const categoryColors: Record<string, string> = {
  cloud: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
  development: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
  kubernetes: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
};

const now = new Date();
const posts = (await getCollection('posts', ({ data }) => !data.draft && (!import.meta.env.PROD || data.date <= now)))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const categories = new Map<string, typeof posts>();
for (const post of posts) {
  const cat = post.data.category;
  const existing = categories.get(cat) ?? [];
  existing.push(post);
  categories.set(cat, existing);
}

// Sort categories by post count descending
const sortedCategories = Array.from(categories.entries())
  .sort((a, b) => b[1].length - a[1].length);

const siteUrl = Astro.site?.toString().replace(/\/$/, '') ?? 'https://mjasion.pl';

const collectionPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'All Posts',
  description: 'Browse all articles by Marcin Jasion, grouped by category',
  url: `${siteUrl}/posts/`,
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: posts.length,
    itemListElement: posts.map((post, i) => ({
      '@type': 'ListItem',
      position: i + 1,
      url: `${siteUrl}/posts/${post.id}/`,
    })),
  },
};
---

<BaseLayout
  title="All Posts"
  description="Browse all articles by Marcin Jasion, grouped by category"
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  </Fragment>
  <div class="mx-auto max-w-6xl px-4 py-8">
    <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">All Posts</h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">{posts.length} articles across {sortedCategories.length} categories</p>

    <div class="mt-10 space-y-12">
      {sortedCategories.map(([category, categoryPosts]) => (
        <section>
          <div class="flex items-center gap-3 mb-6">
            <a
              href={`/posts/${category}/`}
              class={`rounded-full px-3 py-1 text-sm font-medium ${categoryColors[category]} hover:opacity-80 transition-opacity`}
            >
              {categoryLabels[category] ?? category}
            </a>
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {categoryPosts.length} {categoryPosts.length === 1 ? 'post' : 'posts'}
            </span>
          </div>
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
            {categoryPosts.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>
        </section>
      ))}
    </div>
  </div>
</BaseLayout>
